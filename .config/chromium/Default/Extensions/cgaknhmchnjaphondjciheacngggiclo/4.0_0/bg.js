// Facepad - Extension for Google Chrome, Copyright (c) 2012 Mixesoft. All Rights Reserved
(function(){function p(a){a==e&&j()}function r(a){a==e&&(chrome.windows.onFocusChanged.removeListener(p),chrome.windows.onRemoved.removeListener(r),e=-1)}function s(){chrome.windows.create({url:"http://touch.facebook.com/messages/?query=is%3Aunread",type:"popup",top:a.t,left:a.l,width:a.w,height:a.h},function(a){e=a.id;chrome.windows.onFocusChanged.addListener(p);chrome.windows.onRemoved.addListener(r)})}function j(){f&&(f.cancel(),f=0)}function l(){g&&a.auto&&t();h=setTimeout(l,a.i)}function t(){var q=
function(c){if(c)if(0<c.indexOf("login.php"))m(0);else{m(1);var b=c.indexOf("strong>");b&&(i2=c.indexOf("(",b))&&(b=parseInt(c.slice(i2+1,i2+4)));c=isNaN(b)?0:b;b=chrome.i18n.getMessage("s2",[c.toString()]);0<c?(k(c.toString()),i(chrome.i18n.getMessage("s0")+"\n"+b),c={img:"48.png",title:"Facepad",msg:b},f&&j(),a.notify&&(a.nd&&(f=c.url?webkitNotifications.createHTMLNotification(c.url):webkitNotifications.createNotification(c.img,c.title,c.msg),f.onclick=function(){-1<e?chrome.windows.update(e,{focused:!0}):
s();f.cancel();f=0},f.onerror=function(){f=0},f.show(),setTimeout(j,9E3)),a.ns&&(new Audio("notify.ogg")).play())):(k(""),i(chrome.i18n.getMessage("s0")))}},d=new XMLHttpRequest;d.open("GET","http://touch.facebook.com/messages/?query=is%3Aunread&__m_async_page__&__ajax__",!0);d.onload=function(){200==this.status?q(this.response):q(0)};d.send()}function m(a){a?g||(g=1,chrome.browserAction.setIcon({path:"19.png"}),i(chrome.i18n.getMessage("s0"))):(g=0,chrome.browserAction.setIcon({path:"19g.png"}),
k(""),i(chrome.i18n.getMessage("s1")))}function i(a){chrome.browserAction.setTitle({title:a})}function k(a){chrome.browserAction.setBadgeText({text:a})}var e=-1,f=0,g=0,h=0,a={v:"4.0",t:64,l:screen.availWidth-570,w:512,h:512,auto:1,i:3E5,notify:1,ns:1,nd:1};a:{var d=localStorage.getItem("opt");if(void 0==d)localStorage.setItem("opt",JSON.stringify(a)),chrome.tabs.create({url:"opt.html?v=n"});else{try{d=JSON.parse(d)}catch(u){break a}void 0==d.v&&(d.v="1.1",localStorage.removeItem("v"));if("4.0"!=
d.v){for(var n in d)void 0!=a[n]&&(a[n]=d[n]);a.v="4.0";localStorage.setItem("opt",JSON.stringify(a));chrome.tabs.create({url:"opt.html?v=u"})}else a=d}t();h=setTimeout(l,a.i);chrome.extension.onRequest.addListener(function(d,f,c){var b;try{b=JSON.parse(d)}catch(g){return}0==b.id?(k(""),i(chrome.i18n.getMessage("s0")),m(b.logged_in),j(),b.touch&&-1<e&&chrome.tabs.getAllInWindow(e,function(){})):1==b.id&&b.touch&&-1<e&&-1<e&&chrome.windows.get(e,function(b){"popup"==b.type&&(a.t=b.top,a.l=b.left,a.w=
b.width,a.h=b.height,localStorage.setItem("opt",JSON.stringify(a)))});3==b.id?c({opt:a,extURL:chrome.extension.getURL("")}):4==b.id&&(a[b.name]=b.value,localStorage.setItem("opt",JSON.stringify(a)),"i"===b.name&&(h&&clearTimeout(h),h=setTimeout(l,a.i)))});chrome.browserAction.onClicked.addListener(function(){-1<e?chrome.windows.update(e,{focused:!0}):(a.l<-a.w?a.l=0:a.l>screen.availWidth&&(a.l=screen.availWidth-a.w),0>a.t?a.t=0:a.t>screen.availHeight&&(a.t=screen.availHeight-a.h),screen.availWidth&&
s())})}})();