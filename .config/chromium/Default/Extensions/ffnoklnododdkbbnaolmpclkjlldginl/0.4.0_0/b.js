(function(){var p=function(){this.i=-1;this.list=[]};p.prototype.next=function(){this.i++;if(this.i<this.list.length){var u=this.list[this.i];u.apply(this)}};p.prototype.append=function(u){this.list.push(u)};var e=[];var i=[];var r=function(u,v){v="^"+v.replace(/([-()\[\]{}+?.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08").replace(/\*/g,".*");return(o(u,v))};var o=function(w,x){try{var u=(new RegExp(x)).test(w)}catch(v){u=false}return u};var g={};var d=function(u){g[u]=true};var b=function(u){return g.hasOwnProperty(u)};var k=function(u){if(b(u)){delete (g[u])}};var m={};var s=function(u,w){var v=hex_md5(u);m[v]=w};var h=function(u){var v=hex_md5(u);return m[v]};var j=function(y,w,A){var M=w.tab.id;var G=false;if(y.action=="pushHistoryKey"){d(y.key);A()}else{if(y.action=="checkHistoryKey"){A(JSON.stringify(b(y.key)))}else{if(y.action=="delHistoryKey"){k(y.key);A()}else{if(y.action=="getPagerizeData"){var z=y.url;if(e.length==0||!z){A()}else{var C=[];for(var F=0,D=e.length;F<D;F++){if(!e[F].data){continue}if(!G){if(e[F].data.url.length<12){continue}}if(o(z,e[F].data.url)){C.push(e[F].data)}}C.sort(function(Q,P){return(P.url.length-Q.url.length)});A(JSON.stringify(C))}}else{if(y.action=="getPagerData"){var z=y.url;if(i.length==0||!z){A()}else{var C=[];for(var F=0,D=i.length;F<D;F++){if(!i[F].u){continue}if(!G){if(i[F].u.length<12){continue}}if(i[F].r){if(o(z,i[F].u)){C.push(i[F])}}else{if(r(z,i[F].u)){C.push(i[F])}}}C.sort(function(Q,P){return(P.u.length-Q.u.length)});A(JSON.stringify(C))}}else{if(y.action=="getCacheData"){var z=y.url;var L=JSON.parse(localStorage.CACHE);if(L.length==0||!z){A()}else{var C=[];for(var F=L.length-1;F>=0;F--){if(!L[F].u){continue}if(!G){if(L[F].u.length<12){continue}}if(L[F].r){if(o(z,L[F].u)){C.push(L[F])}}else{if(r(z,L[F].u)){C.push(L[F])}}}C.sort(function(Q,P){return(P.u.length-Q.u.length)});A(JSON.stringify(C))}}else{if(y.action=="putCacheData"){var L=JSON.parse(localStorage.CACHE);var v=30;for(var F=0,D=L.length;F<D;F++){if(JSON.stringify(L[F])==y.dataJSON){A();return}}var N=JSON.parse(y.dataJSON);L.push(N);var D=L.length;if(D>v){L=L.slice(D-v,D)}localStorage.CACHE=JSON.stringify(L);A()}else{if(y.action=="checkExceptions"){var I=JSON.parse(localStorage.OPTION_EXCEPTIONS);for(var F=0,D=I.length;F<D;F++){if(o(y.url,I[F])){A(JSON.stringify(false));return}}A(JSON.stringify(true))}else{if(y.action=="checkLang"){var E=h(y.url);if(E){var O=E;if(O=="ja"){A(JSON.stringify(true))}else{A(JSON.stringify(false))}}else{try{chrome.tabs.detectLanguage(M,function(P){if(P=="ja"){A(JSON.stringify(true))}else{A(JSON.stringify(false))}s(y.url,P)})}catch(J){A(JSON.stringify(false))}}}else{if(y.action=="saveException"){var H=y.pattern;try{(new RegExp(H));if(H!=""){var I=JSON.parse(localStorage.OPTION_EXCEPTIONS);I.push(H);localStorage.OPTION_EXCEPTIONS=JSON.stringify(I)}}catch(J){}A()}else{if(y.action=="getState"){A(localStorage.RUN)}else{if(y.action=="getOptions"){var x={};x.OPTION_PAGE_NUMBERING=JSON.parse(localStorage.OPTION_PAGE_NUMBERING);x.OPTION_DOM_DIRECT=JSON.parse(localStorage.OPTION_DOM_DIRECT);x.OPTION_APPEND_HISTORY=JSON.parse(localStorage.OPTION_APPEND_HISTORY);A(JSON.stringify(x))}else{if(y.action=="xhr"){var z=y.url;var B=new XMLHttpRequest();var K=function(){A(B.responseText)};var u=function(){A("")};B.onload=K;B.onerror=u;B.open("GET",z,true);B.send()}else{throw ("UnknownActionError")}}}}}}}}}}}}}};var c,l;var q=function(v,u){localStorage.RUN=JSON.stringify(!JSON.parse(localStorage.RUN));chrome.contextMenus.update(c,{checked:JSON.parse(localStorage.RUN)},function(){})};var f=function(v,u){chrome.windows.create({url:chrome.extension.getURL("d.html"),type:"popup",width:400,height:200},function(x){chrome.tabs.sendRequest(x.tabs[0].id,{action:"onloadPopup",url:u.url},function(){})})};var a=function(){c=chrome.contextMenus.create({type:"checkbox",title:"Enable Infinitie Scroll",checked:JSON.parse(localStorage.RUN),onclick:q},function(){});l=chrome.contextMenus.create({type:"normal",title:"Add new exception",onclick:f},function(){})};var t=function(x,u){var v=new p();var y=function(z,A){return function(){var C=function(){if(A=="pagerize"){try{e=e.concat(JSON.parse(D.responseText))}catch(E){v.next()}}else{if(A=="pager"){try{i=i.concat(JSON.parse(D.responseText))}catch(E){v.next()}}}};var B=function(){v.next()};var D=new XMLHttpRequest();D.onload=C;D.onerror=B;D.open("GET",z,true);D.send()}};for(var w=0;w<u.length;w++){v.append(y(u[w],x))}v.next()};var n=function(){if(!localStorage.hasOwnProperty("RUN")){localStorage.RUN=JSON.stringify(true)}if(!localStorage.hasOwnProperty("OPTION_RIGHT_CLICK_MENU")){localStorage.OPTION_RIGHT_CLICK_MENU=JSON.stringify(true)}if(!localStorage.hasOwnProperty("OPTION_PAGE_NUMBERING")){localStorage.OPTION_PAGE_NUMBERING=JSON.stringify(false)}if(!localStorage.hasOwnProperty("OPTION_APPEND_HISTORY")){localStorage.OPTION_APPEND_HISTORY=JSON.stringify(false)}if(!localStorage.hasOwnProperty("OPTION_DOM_DIRECT")){localStorage.OPTION_DOM_DIRECT=JSON.stringify(false)}if(!localStorage.hasOwnProperty("OPTION_EXCEPTIONS")){localStorage.OPTION_EXCEPTIONS=JSON.stringify(["^http\\://www\\.google\\.com/.*","^http\\://twitter\\.com/.*"])}if(!localStorage.hasOwnProperty("CACHE")){localStorage.CACHE=JSON.stringify([])}var u=function(){e=[];i=[];t("pagerize",["http://wedata.net/databases/AutoPagerize/items.json",chrome.extension.getURL("pagerize/items.json")]);t("pager",[chrome.extension.getURL("pager/items.json")])};u();var v=1000*60*60*1;setInterval(u,v*3);chrome.extension.onRequest.addListener(j);if(JSON.parse(localStorage.OPTION_RIGHT_CLICK_MENU)){a()}};n()})();