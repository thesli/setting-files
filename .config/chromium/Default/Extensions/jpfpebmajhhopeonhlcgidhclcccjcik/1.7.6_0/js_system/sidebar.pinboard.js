$(function(){var c=getValue("options.sidebar.pinboardUsername");$(document).on("click",".pinboard_tag",function(){b($(this).attr("rel"))});var f=[];function b(g){$("#pinboard h1:nth(0)").addClass("loading");if(g=="last25bookmarks"){d_url="http://feeds.pinboard.in/json/v1/u:"+c+"/?count=25"}else{t=g;if(g.indexOf("+")){t=g.replace("+","/t:")}d_url="http://feeds.pinboard.in/json/v1/u:"+c+"/t:"+t+"?count=1000000"}$.getJSON(d_url,function(o){var h=[];var k=new Array;var m=new Array;$.each(o,function(s,u){var q=(String(u.t)).split(",");for(var r=0;r<q.length;r++){if(g.indexOf(q[r])<0){k.push(q[r])}}h.push('<li style="background-image:url(chrome://favicon/'+u.u+')" class="openurl" rel="'+u.u+'"><a href="'+u.u+'">'+u.d+" <span>#"+u.t+"</span></a></li>")});k=$.unique(k);var p="<hr />";if(k.length>0&&g!="last25bookmarks"){for(var j=0;j<k.length;j++){m.push('<a class="pinboard_tag delicious_combine_with" rel="'+g+"+"+k[j]+'">'+k[j]+"</a>&nbsp;&nbsp;")}p="<hr /><b>+</b> "+m.join(" ")+"<hr />"}$("#d_bookmarks").html(p+h.join(""));if(panels==1){$("#sidebars").css("width",281+281);if($("#sidebars >div").length==1){$("#sidebars").append('<div style="height:100%">')}}var n=g.split("+");var l=[];for(var j=0;j<n.length;j++){if(n.length>1){if(j>0){removetag=g.replace("+"+n[j],"")}else{removetag=g.replace(n[j]+"+","")}l.push('<div><h1 class="pinboard_tag" rel="'+n[j]+'">#'+n[j]+'</h1><a class="pinboard_tag delicious_closetag" rel="'+removetag+'"></a></div>')}else{l.push('<h1 class="pinboard_tag" rel="'+n[j]+'">#'+n[j]+"</h1>")}}$("#d_bookmarks").prepend('<a id="delicious_close">close</a>'+l.join(""));$("#d_bookmarks").prependTo("#sidebars>div:nth-child(2)").css("height","100%").show();$("#pinboard h1").removeClass("loading")})}function d(k){var h=[];var g=[];for(var j=0;j<f.length;j++){if(f[j].indexOf(k)==0){h.push('<li class="pinboard_tag" rel="'+f[j]+'"><a>'+f[j]+"</a></span></li>");g.push(f[j])}}$("#pinboard ul#d_tags").html(h.join(""));if(g.length==1){b(g[0])}else{$("#pinboard ul#d_bookmarks").hide()}$("#pinboard h1").removeClass("loading")}$("#pinboard-search input").keyup(function(g){query=$(this).val();if(query.length<1){return false}$("#pinboard h1").addClass("loading");d(query);if(g.which==13){b(query)}});var e={tags:{},bookmarks:[]};if((getValue("_tmp_pinboard.tags")!="undefined"&&getValue("_tmp_pinboard.tags"))){var a=JSON.parse(getValue("_tmp_pinboard.tags"));$.each(a,function(h,g){f.push(g.tag);$("#pinboard ul#d_tags").append('<li class="pinboard_tag" rel="'+g.tag+'"><a>'+g.tag+" <span>"+g.count+"</span></a></li>")})}else{$.getJSON("http://feeds.pinboard.in/json/v1/u:"+c+"/?count=1000000",function(l){for(var h=0;h<l.length;++h){for(var g=0;g<l[h].t.length;++g){if(!e.tags[l[h].t[g]]){e.tags[l[h].t[g]]=1}else{e.tags[l[h].t[g]]++}}e.bookmarks.push(l)}a=[];$.each(e.tags,function(i,j){a.push({tag:i,count:j})});var k=function(j,i){return i.count-j.count};a.sort(k);$.each(a,function(j,i){f.push(i.tag);$("#pinboard ul#d_tags").append('<li class="pinboard_tag" rel="'+i.tag+'"><a>'+i.tag+" <span>"+i.count+"</span> </a></li>")});setValue("_tmp_pinboard.tags",JSON.stringify(a,null,2))})}});