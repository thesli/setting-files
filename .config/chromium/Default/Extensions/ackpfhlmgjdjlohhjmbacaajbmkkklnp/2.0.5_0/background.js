var id=100,tabsCnt,screenshots,currentTabId;chrome.extension.onRequest.addListener(function(a,c,b){a&&a.localStorage?b(localStorage.hotkey?localStorage.hotkey:"ctrl + shift + 69"):takeScreenshot()});
function takeScreenshot(){chrome.windows.getAll({populate:!0},function(a){for(var b=0;b<a.length;b++)for(var d=0;d<a[b].tabs.length;d++)if(a[b].tabs[d].url.search("exposeDisplay.html")>0){chrome.tabs.remove(a[b].tabs[d].id);break}});var a=[chrome.extension.getURL("exposeDisplay.html"),"?id=",id++].join("");chrome.tabs.create({url:a},function(c){var b=c.id;chrome.tabs.onUpdated.addListener(function(c,h){if(!(c!=b||h.status!="complete"))for(var f=chrome.extension.getViews(),e=0;e<f.length;e++){var g=
f[e];if(g.location.href==a){g.setScreenshotUrl(b);break}}})})}chrome.browserAction.onClicked.addListener(function(){if(window.localStorage.mode!=1&&window.localStorage.mode!=2)window.localStorage.mode=2,chrome.browserAction.setPopup({popup:"popup.html"});window.localStorage.mode!=2?takeScreenshot():chrome.browserAction.setPopup({popup:"popup.html"})});
function countTabs(){tabsCnt=0;screenshots=[];chrome.windows.getAll({populate:!0},function(a){for(var c=0;c<a.length;c++)for(var b=0;b<a[c].tabs.length;b++)tabsCnt++;if(window.localStorage.hasCount!=1&&window.localStorage.hasCount!=2)window.localStorage.hasCount=1;window.localStorage.hasCount==2?chrome.browserAction.setBadgeText({text:""}):window.localStorage.hasCount==1&&(chrome.browserAction.setBadgeText({text:tabsCnt.toString()}),chrome.browserAction.setBadgeBackgroundColor({color:[242,101,34,
255]}))});window.localStorage.mode==1&&chrome.browserAction.setPopup({popup:""})}chrome.tabs.onCreated.addListener(function(){tabsCnt++;window.localStorage.hasCount==1&&chrome.browserAction.setBadgeText({text:tabsCnt.toString()})});chrome.tabs.onRemoved.addListener(function(a){tabsCnt--;window.localStorage.hasCount==1&&chrome.browserAction.setBadgeText({text:tabsCnt.toString()});screenshots[a]&&(screenshots[a]=null)});
chrome.tabs.onSelectionChanged.addListener(function(a,c){chrome.tabs.getSelected(c.windowId,function(b){b.status=="complete"&&chrome.tabs.captureVisibleTab(c.windowId,function(b){screenshots[a]=b})});chrome.tabs.getSelected(null,function(a){if(a.url.search("exposeDisplay.html")<=0)currentTabId=a.id})});function getSs(a){return screenshots[a]}
chrome.tabs.onUpdated.addListener(function(a,c){c.status!="complete"&&screenshots[a]?screenshots[a]=null:c.status=="complete"&&chrome.windows.getLastFocused(function(b){chrome.tabs.getSelected(b.id,function(b){b.id==a&&chrome.tabs.captureVisibleTab(b.windowId,function(b){screenshots[a]=b})})})});function getSelected(){return currentTabId};