<html>
<head>
<script>

// Global variables that will be reused
var ctx,canvas,img;
// ------------------------------------------------------------------
// functions of popup that have to be executed on the background page

// bookmark selected tabs
function bookmark(found,name){
// Create or get Bookmark folder
chrome.bookmarks.getChildren("0", function(children){

        var otherid = (children[1]).id;

        name = prompt("Please enter the name of the bookmark folder:", name);

	if(name)
        chrome.bookmarks.create( {'parentId': otherid ,'title': name+' (Tabs+)'},
                                function(folder) {
                                  folderid = folder.id;

                                  // create bookmarks 
                                        for(i=0;i<found.length;i++){
                                                tab = found[i];
                                                chrome.bookmarks.create({'parentId': folderid,
                                                        'title': tab.title,
                                                        'url':  tab.url});
                                                }

                                }); 
//       window.setTimeout('init(true);',100);
});

}


// move tabs in "found" to new window
function moveToNewWindow(found){

	chrome.windows.create({url: 'about:blank'}, function (w){
			var firstindex = 1;

			for(i=0; i<found.length; i++){
			chrome.tabs.move(found[i].id,{index: firstindex, windowId: w.id});
			firstindex++;
			}

			chrome.tabs.getAllInWindow(w.id,function(tabs){
				chrome.tabs.remove(tabs[0].id);

				});	
			// window.setTimeout('init(true);',100);	
			});

}

// close tabs in "found"
function closefound(found){
	for(i=0; i<found.length; i++){
		chrome.tabs.remove(found[i].id);
	}
}

// switch tabs in windows "win1" and "win2"
function switchWindows(win1, win2, found, tabid ){ 

	chrome.tabs.create({windowId: win1,url: 'about:blank'}, function (t){
			for(i=0;i<found.length; i++){
			if(found[i].windowId == win2){
			chrome.tabs.move(found[i].id,{index: found[i].index, windowId: win1});
			}
			}

			chrome.tabs.remove(t.id);
			chrome.tabs.update(tabid, {selected: true});
			});


	chrome.tabs.create({windowId: win2,url: 'about:blank'}, function (t){
			for(i=0;i<found.length; i++){
			if(found[i].windowId == win1){
			chrome.tabs.move(found[i].id,{index: found[i].index, windowId: win2});
			}
			}


			chrome.tabs.remove(t.id);

			chrome.tabs.update(tabid, {selected: true});
			});




}

// ------------------------------------------------------------------
// functions of background page


// Get canvas and canvas context, show help page on fresh install or update
function init(){
	canvas = document.getElementById('c');
	ctx = canvas.getContext('2d');
	img = new Image();

	if(localStorage["tabsplus_version"] == null || 
			localStorage["tabsplus_version"] != "1.0") {
		localStorage["tabsplus_version"] = "1.0";
		chrome.tabs.create({url : "help.html"});        
	}


}


// update thumbnail of current tab
function update(){

	chrome.tabs.getSelected(null, function(currentTab) {
			chrome.tabs.captureVisibleTab(currentTab.windowId, function(data){
				img.onload = function()
				{
				var height = Math.round((img.width/200)*140);
				var width = img.width;
				if(height > img.height){
				height = img.height;
				width = Math.round((img.height/140)*200);
				}

				ctx.drawImage(img, 0, 0, width, height, 0, 0, 200, 140);
				localStorage['thumb'+currentTab.id]  = canvas.toDataURL("image/png");


				}

				img.src = data;
				if (img.complete) { img.onload(); }
				});
	});

        // update tab count badge

	console.log(localStorage['showcount']);
	if(localStorage['showcount'] === undefined || localStorage['showcountw'] === undefined || localStorage['showcount'] == 0 ||  localStorage['showcountw'] == 0 ){
	chrome.windows.getAll({populate: true}, function (windows){

		var wcount = windows.length;
		var tcount = 0;
	      for(i=0; i<windows.length; i++){
			tcount += windows[i].tabs.length;
		}

		var text = "";

		if(localStorage['showcount'] === undefined  || localStorage['showcount'] == 0) text += tcount;
		if(localStorage['showcountw'] === undefined  || localStorage['showcountw'] == 0) {
		   if(text != "") text += '/';
	           text += wcount;
		}

        	 chrome.browserAction.setBadgeBackgroundColor({color: [0,255,0,200]});
    		chrome.browserAction.setBadgeText({text: text});
	});
	}
	else
    		chrome.browserAction.setBadgeText({text: ''});
	
}


// ------------------------------------------------------------------
// Event handlers

// Request handler for keyboard shortcuts
chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
		console.log(chrome.extension.getURL("tabs.html"));
		chrome.tabs.create({url:chrome.extension.getURL("tabs.html")});

		}
		);


// update thumbnail on selection change
chrome.tabs.onSelectionChanged.addListener(function(tabId, selectInfo) {
		update();
		});

// update thumbnail on page update
chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
		update();
		});

// delete thumbnail on tab close
chrome.tabs.onRemoved.addListener(function(tabId) {
		delete localStorage['thumb'+tabId];
		});


</script>
</head>
<body onload='init();'>
<canvas id='c' width='200' height='140'></canvas>
</body>
</html>
