define("background/notifications",[],function(){"use strict";function e(e){clearTimeout(t);var i=_.extend({type:"basic",title:"",message:"",iconUrl:""},e);chrome.notifications.create(n,i,function(e){n=e||""}),t=setTimeout(function(){n&&""!==n&&chrome.notifications.clear(n,function(){n=""})},3e3)}var t,n="";return{showNotification:function(t){"undefined"!=typeof chrome.notifications&&(chrome.notifications.getPermissionLevel?chrome.notifications.getPermissionLevel(function(n){"granted"===n&&e(t)}):e(t))}}}),define("background/mixin/sequencedCollectionMixin",{moveToIndex:function(e,t){var n=this.get(e),i=this.getSequenceFromIndex(t);n.set("sequence",i),n.save(),this.sort()},getSequenceFromIndex:function(e){var t,n=1e4;if(0===this.length)t=n;else{var i;i=e<this.length?this.at(e).get("sequence"):this.at(this.length-1).get("sequence")+2*n;var o=0;e>0&&(o=this.at(e-1).get("sequence")),t=(i+o)/2}return t}}),define("background/collection/multiSelectCollection",[],function(){"use strict";var e=Backbone.Collection.extend({initialize:function(){this.on("change:selected",function(e,t){var n=this.selected();1===n.length&&n[0].set("firstSelected",!0),t||e.set("firstSelected",!1)}),this.on("change:firstSelected",function(e,t){t&&this.each(function(t){t!==e&&t.set("firstSelected",!1)})})},deselectAll:function(){this.deselectAllExcept(null)},deselectAllExcept:function(e){var t=this.selected();_.each(t,function(t){t.cid!=e&&t.set("selected",!1)})},selected:function(){return this.where({selected:!0})},firstSelected:function(){return this.findWhere({firstSelected:!0})}});return e}),define("background/model/settings",[],function(){"use strict";var e=Backbone.Model.extend({defaults:function(){var e=this.getItem("remindClearStream"),t=this.getItem("remindDeletePlaylist"),n=this.getItem("showTimeRemaining"),i=this.getItem("showTooltips"),o=this.getItem("alwaysOpenToSearch");return{localDebug:!1,testing:!1,serverURL:"",suggestedQuality:this.getItem("suggestedQuality")||"default",userId:this.getItem("userId")||null,showTooltips:null===i?!0:i,remindClearStream:null===e?!0:e,remindDeletePlaylist:null===t?!0:t,showTimeRemaining:null===n?!1:n,searchQuery:this.getItem("searchQuery")||"",alwaysOpenToSearch:null===o?!1:o}},initialize:function(){this.get("localDebug")?this.set("serverURL","http://localhost:61975/"):this.set("serverURL","http://streamus.apphb.com/"),this.on("change:suggestedQuality",function(e,t){localStorage.setItem("suggestedQuality",t)}),this.on("change:userId",function(e,t){localStorage.setItem("userId",JSON.stringify(t))}),this.on("change:alwaysOpenToSearch",function(e,t){localStorage.setItem("alwaysOpenToSearch",JSON.stringify(t))}),this.on("change:showTooltips",function(e,t){localStorage.setItem("showTooltips",JSON.stringify(t))}),this.on("change:remindClearStream",function(e,t){localStorage.setItem("remindClearStream",JSON.stringify(t))}),this.on("change:remindDeletePlaylist",function(e,t){localStorage.setItem("remindDeletePlaylist",JSON.stringify(t))}),this.on("change:showTimeRemaining",function(e,t){localStorage.setItem("showTimeRemaining",JSON.stringify(t))}),this.on("change:searchQuery",function(e,t){localStorage.setItem("searchQuery",JSON.stringify(t))})},getItem:function(e){var t=localStorage.getItem(e);if(null!==t)try{t=JSON.parse(t)}catch(n){}return t}});return window.Settings=new e,window.Settings}),define("common/model/utility",[],function(){"use strict";var e=Backbone.Model.extend({prettyPrintTime:function(e){isNaN(e)&&(e=0);var t=Math.floor(e/3600),n=e%3600,i=Math.floor(n/60);n%=60,10>i&&(i="0"+i),10>n&&(n="0"+n);var o=i+":"+n;return t>0&&(o=t+":"+o),o},iso8061DurationToSeconds:function(e){var t=e.match(/(\d+)H/),n=parseInt(t?t[1]:0),i=e.match(/(\d+)M/),o=parseInt(i?i[1]:0),s=e.match(/(\d+)S/),r=parseInt(s?s[1]:0),a=r+60*o+3600*n;return a},cleanseVideoTitle:function(e){return e=$.trim(e),e=e.replace(/\s*\*+\s?\S+\s?\*+$/,""),e=e.replace(/\s*\[[^\]]+\]$/,""),e=e.replace(/\s*\([^\)]*version\)$/i,""),e=e.replace(/\s*\.(avi|wmv|mpg|mpeg|flv)$/i,""),e=e.replace(/\s*(of+icial\s*)?(music\s*)?video/i,""),e=e.replace(/\s*(ALBUM TRACK\s*)?(album track\s*)/i,""),e=e.replace(/\s*\(\s*of+icial\s*\)/i,""),e=e.replace(/\s*\(\s*[0-9]{4}\s*\)/i,""),e=e.replace(/\s+\(\s*(HD|HQ)\s*\)$/,""),e=e.replace(/\s+(HD|HQ)\s*$/,""),e=e.replace(/\s*video\s*clip/i,""),e=e.replace(/\s+\(?live\)?$/i,""),e=e.replace(/\(\s*\)/,""),e=e.replace(/\(.*lyrics?\)/i,""),e=e.replace(/\s*with\s+lyrics?\s*$/i,""),e=e.replace(/^(|.*\s)"(.*)"(\s.*|)$/,"$2"),e=e.replace(/^(|.*\s)'(.*)'(\s.*|)$/,"$2"),e=e.replace(/^[\/\s,:;~-\s"]+/,""),e=e.replace(/[\/\s,:;~-\s"\s!]+$/,"")},getLevenshteinDistance:function(e,t){var n=[],i=e.length,o=t.length;if(0===i)return o;if(0===o)return i;for(var s=i;s>=0;s--)n[s]=[];for(var r=i;r>=0;r--)n[r][0]=r;for(var a=o;a>=0;a--)n[0][a]=a;for(var d=1;i>=d;d++)for(var l=e.charAt(d-1),u=1;o>=u;u++){if(d==u&&n[d][u]>4)return i;var c=t.charAt(u-1),g=l==c?0:1,h=n[d-1][u]+1,f=n[d][u-1]+1,m=n[d-1][u-1]+g;h>f&&(h=f),h>m&&(h=m),n[d][u]=h,d>1&&u>1&&l==t.charAt(u-2)&&e.charAt(d-2)==c&&(n[d][u]=Math.min(n[d][u],n[d-2][u-2]+g))}return n[i][o]},escapeRegExp:function(e){var t=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");return t}});return new e}),define("background/model/video",["background/model/settings","common/model/utility"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:function(){return{id:"",title:"",author:"",duration:-1,prettyDuration:"",url:"",cleanTitle:"",highDefinition:!1}},urlRoot:e.get("serverURL")+"Video/",initialize:function(){this.on("change:duration",this.setPrettyDuration),this.on("change:title",this.setCleanTitle),this.on("change:id",this.setURL),this.setPrettyDuration(),this.setCleanTitle(),this.setURL()},setPrettyDuration:function(){this.set("prettyDuration",t.prettyPrintTime(this.get("duration")))},setCleanTitle:function(){this.set("cleanTitle",t.cleanseVideoTitle(this.get("title")))},setURL:function(){this.set("url","https://youtu.be/"+this.get("id"))}});return function(e){if(void 0===e)throw"Video expects to be constructed with either videoInformation or properties";void 0!==e.videoInformation&&(e.videoInformation.id&&11===e.videoInformation.id.length?$.extend(e,e.videoInformation):(e.id=e.videoInformation.media$group.yt$videoid.$t,e.title=e.videoInformation.title.$t,e.duration=parseInt(e.videoInformation.media$group.yt$duration.seconds,10),e.author=e.videoInformation.author[0].name.$t,e.highDefinition=null!=e.videoInformation.yt$hd),delete e.videoInformation);var t=new n(e);return t}}),define("background/model/playlistItem",["background/model/settings","background/model/video"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:function(){return{id:null,playlistId:null,sequence:-1,video:null,title:"",selected:!1,firstSelected:!1}},urlRoot:e.get("serverURL")+"PlaylistItem/",parse:function(e){for(var t in e)e.hasOwnProperty(t)&&"00000000-0000-0000-0000-000000000000"===e[t]&&(e[t]=null);return this.get("video").set(e.video),delete e.video,e},toJSON:function(){var e=Backbone.Model.prototype.toJSON.apply(this,arguments);return e.cid=this.cid,e},initialize:function(){var e=this.get("video");e instanceof Backbone.Model||(e=new t(e),this.set("video",e,{silent:!0}))}});return function(e){(e&&void 0===e.title||""===e.title)&&(e.title=e.video.get?e.video.get("title"):e.video.title);var t=new n(e);return t}}),define("background/collection/playlistItems",["background/collection/multiSelectCollection","background/mixin/sequencedCollectionMixin","background/model/playlistItem","background/model/settings"],function(e,t,n,i){function o(e){var t=this.find(function(t){return t.get("video").get("id")===e.get("video").get("id")});void 0!==t&&(t.has("id")?e.set("id",t.get("id")):e.cid=t.cid)}var s=e.extend({model:n,playlistId:null,comparator:"sequence",initialize:function(t,n){void 0!==n||_.isArray(t)||(n=t),this.playlistId=n.playlistId,e.prototype.initialize.apply(this,arguments)},save:function(e,t){var n=this;if(this.filter(function(e){return!e.isNew()}).length>0)throw"Not Supported Yet";var o=this.filter(function(e){return e.isNew()});1===o.length?o[0].save({},{success:t?t.success:null,error:t?t.error:null}):o.length>1&&$.ajax({url:i.get("serverURL")+"PlaylistItem/CreateMultiple",type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(o),success:function(e){_.each(e,function(e){var t=n.find(function(t){return t.cid===e.cid}),i=t.parse(e);t.set(i)}),n.trigger("sync"),t.success&&t.success()},error:t?t.error:null})},addByVideoAtIndex:function(e,t,i){var o=this.getSequenceFromIndex(t),s=new n({playlistId:this.playlistId,video:e,sequence:o}),r=this;this.savePlaylistItem(s,function(){r.sort(),i&&i()})},savePlaylistItem:function(e,t){this.videoAlreadyExists(e.get("video"))?t&&t(e):e.save({},{success:function(){this.add(e),t&&t(e)}.bind(this),error:function(e){console.error(e)}})},videoAlreadyExists:function(e){return this.some(function(t){return t.get("video").get("id")===e.get("id")})}});return s.prototype.add=function(t,n){return _.isArray(t)?_.each(t,function(e){o.call(this,e)}.bind(this)):o.call(this,t),e.prototype.add.call(this,t,n)},_.extend(s.prototype,t),s}),define("background/model/shareCode",["background/model/settings"],function(e){"use strict";var t=Backbone.Model.extend({defaults:{id:null,entityType:-1,entityId:null,shortId:null,urlFriendlyEntityTitle:""},urlRoot:e.get("serverURL")+"ShareCode/"});return t}),define("enum/repeatButtonState",{Disabled:0,RepeatVideo:1,RepeatStream:2}),define("enum/shareableEntityType",{None:-1,Playlist:0}),define("background/model/playlist",["background/collection/playlistItems","background/model/playlistItem","background/model/settings","background/model/video","background/model/shareCode","enum/repeatButtonState","enum/shareableEntityType"],function(e,t,n,i,o,s,r){"use strict";var a=Backbone.Model.extend({defaults:function(){return{id:null,folderId:null,title:chrome.i18n.getMessage("newPlaylist"),items:null,dataSource:null,dataSourceLoaded:!1,active:!1,displayInfo:"",sequence:-1}},urlRoot:n.get("serverURL")+"Playlist/",parse:function(e){for(var t in e)e.hasOwnProperty(t)&&"00000000-0000-0000-0000-000000000000"===e[t]&&(e[t]=null);return this.get("items").reset(e.items),this.get("items").playlistId=this.get("id"),delete e.items,this.setDisplayInfo(),e},initialize:function(){var t=this,i=this.get("items");i instanceof Backbone.Collection||(i=new e(i,{playlistId:this.get("id")}),this.set("items",i,{silent:!0})),this.on("change:title",_.debounce(function(e,i){$.ajax({url:n.get("serverURL")+"Playlist/UpdateTitle",type:"POST",dataType:"json",data:{playlistId:e.get("id"),title:i},success:function(){t.trigger("sync")},error:function(e){console.error("Error saving title",e)}})},2e3)),this.listenTo(this.get("items"),"add reset remove",this.setDisplayInfo),this.setDisplayInfo(),this.listenTo(this.get("items"),"sync",function(){this.trigger("sync")})},setDisplayInfo:function(){var e,t=this.get("items").pluck("video"),n=_.invoke(t,"get","duration"),i=_.reduce(n,function(e,t){return e+t},0),o=1===t.length?chrome.i18n.getMessage("video"):chrome.i18n.getMessage("videos"),s=Math.floor(i/60);e=1===s?s+" "+chrome.i18n.getMessage("minute"):s>4320?Math.floor(s/1440)+" "+chrome.i18n.getMessage("days"):s>180?Math.floor(s/60)+" "+chrome.i18n.getMessage("hours"):s+" "+chrome.i18n.getMessage("minutes");var r=t.length+" "+o+", "+e;this.set("displayInfo",r)},addByVideo:function(e,n){var i=new t({playlistId:this.get("id"),video:e});this.get("items").savePlaylistItem(i,n)},addByVideos:function(n,i){if(1===n.length)return this.addByVideo(n[0],i);var o=this,s=new e([],{playlistId:this.get("id")});_.each(n,function(e){if(!o.get("items").videoAlreadyExists(e)){var n=new t({playlistId:o.get("id"),video:e});s.push(n)}}),s.save({},{success:function(){o.get("items").add(s.models),i&&i()}})},getShareCode:function(e){var t=this;$.ajax({url:n.get("serverURL")+"ShareCode/GetShareCode",dataType:"json",data:{entityType:r.Playlist,entityId:t.get("id")},success:function(n){var i=new o(n);e(i),t.trigger("sync")},error:function(e){console.error("Error retrieving share code",e,e.message)}})},getPlaylistItemById:function(e){return this.get("items").findWhere({id:e})}});return a}),define("background/collection/playlists",["background/mixin/sequencedCollectionMixin","background/model/playlist"],function(e,t){"use strict";var n=Backbone.Collection.extend({model:t,comparator:"sequence",initialize:function(){this.on("remove",function(e,t,n){if(e.get("active")){var i=this.at(n.index);if(void 0!==i)i.set("active",!0);else{var o=this.at(n.index-1);o.set("active",!0)}}}),this.on("change:active",function(e,t){t&&this.deselectAllExcept(e.get("id"))})},canDelete:function(){return this.length>1},getActivePlaylist:function(){return this.findWhere({active:!0})},deselectAllExcept:function(e){this.each(function(t){t.get("id")!==e&&t.set("active",!1)})}});return _.extend(n.prototype,e),n}),define("enum/dataSourceType",{None:-1,Unknown:0,YouTubePlaylist:1,YouTubeChannel:2,SharedPlaylist:3,UserInput:4,YouTubeFavorites:5,YouTubeAutoGenerated:6,YouTubeVideo:7}),define("common/model/youTubeV2API",["enum/dataSourceType","common/model/utility"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:function(){var e="author,title,media:group(yt:videoid,yt:duration),yt:accessControl,yt:hd";return{videoInformationFields:e,videoListInformationFields:"entry("+e+")"}},sendV2ApiRequest:function(e){return""===$.trim(e.url)&&(console.error("URL expected"),e.error&&e.error("URL expected"),e.complete&&e.complete()),$.ajax({url:e.url,data:$.extend({},e.data,{v:2,alt:"json",strict:!0}),headers:{"X-GData-Key":"key=AI39si7voIBGFYe-bcndXXe8kex6-N_OSzM5iMuWCdPCSnZxLB_qIEnQ-HMijHrwN1Y9sFINBi_frhjzVVrYunHH8l77wfbLCA"},success:function(){e.success(arguments[0]),e.complete&&e.complete()},error:function(t){"abort"!==t.statusText&&console.error(t.statusText),e.error&&e.error(t),e.complete&&e.complete()}})},search:function(e){return this.sendV2ApiRequest({url:"https://gdata.youtube.com/feeds/api/videos",data:{category:"Music",time:"all_time","max-results":e.maxResults||50,"start-index":1,format:5,q:e.text,fields:this.get("videoListInformationFields")},success:function(t){e.success(t.feed.entry||[])},error:e.error,complete:e.complete})},findPlayableByTitle:function(e){var n=$.trim(e.title||"");return""===n?(e.error&&e.error("No title provided"),null):this.search({text:n,success:function(i){i.sort(function(e,i){return t.getLevenshteinDistance(e.title.$t,n)-t.getLevenshteinDistance(i.title.$t,n)});var o=i.length>0?i[0]:null;e.success(o)},error:e.error})},searchPlaylist:function(e){return this.sendV2ApiRequest({url:"https://gdata.youtube.com/feeds/api/playlists/snippets",data:{"max-results":e.maxResults||50,"start-index":1,q:e.text},success:function(t){e.success(t.feed.entry||[])}})},getChannelName:function(e){return this.sendV2ApiRequest({url:"https://gdata.youtube.com/feeds/api/users/"+e.channelId,success:function(t){e.success(t.entry.author[0].name.$t)},error:e.error})},getPlaylistTitle:function(e){return this.sendV2ApiRequest({url:"https://gdata.youtube.com/feeds/api/playlists/"+e.playlistId,data:{fields:"title"},success:function(t){e.success(t.feed.title.$t)},error:e.error})},getVideoInformation:function(e){return this.sendV2ApiRequest({url:"https://gdata.youtube.com/feeds/api/videos/"+e.videoId,data:{format:5,fields:this.get("videoInformationFields")},success:function(t){var n=this.validateEntry(t.entry);n?e.success(t.entry):this.findPlayableByTitle({title:t.entry.title.$t,success:e.success,error:e.error})}.bind(this),error:function(){this.findPlayableByTitle({title:e.videoTitle,success:e.success,error:e.error})}.bind(this),complete:e.complete})},getDataSourceResults:function(e,t,n){if(e.isV3())throw"YouTubeV2 API getDataSourceResults cannot handle a V3 dataSource";var i=50,o=1+i*t;return this.sendV2ApiRequest({url:e.get("url"),data:{"max-results":i,"start-index":o},success:function(e){var i=_.filter(e.feed.entry,function(e){return void 0!==e.media$group.yt$duration});n&&n({iteration:t,results:i})},error:function(){n&&n({iteration:t,results:[]})}})},validateEntry:function(e){var t=e.yt$accessControl,n=_.find(t,function(e){return"embed"===e.action}),i="allowed"===n.permission;return i}});return new n}),define("common/model/dataSource",["enum/dataSourceType","common/model/youTubeV2API"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:{type:e.None,sourceId:"",url:"",title:""},initialize:function(e){if(e&&e.urlToParse){var t=this.parseUrlForDataSourceInformation(e.urlToParse);this.set("type",t.dataSourceType),this.set("sourceId",t.dataSourceId),delete e.urlToParse}this.setUrl(),this.on("change:type",this.setUrl)},setUrl:function(){var t="https://gdata.youtube.com/feeds/api/";switch(this.get("type")){case e.YouTubeChannel:t+="users/"+this.get("sourceId")+"/uploads";break;case e.YouTubeFavorites:t+="users/"+this.get("sourceId")+"/favorites";break;case e.YouTubePlaylist:t+="playlists/"+this.get("sourceId");break;default:t=""}this.set("url",t)},isV3:function(){var t=this.get("type");return t===e.YouTubeAutoGenerated},needsLoading:function(){var t=this.get("type");return t===e.YouTubeChannel||t===e.YouTubePlaylist||t===e.YouTubeFavorites||t===e.YouTubeAutoGenerated},parseUrlForDataSourceInformation:function(t){var n=e.None,i="",o=this.parseYouTubeVideoIdFromUrl(t);if(o&&(i=o,n=e.YouTubeVideo),n===e.None){var s=[{identifiers:["list=PL","p=PL","list=RD","p=RD"],dataSourceType:e.YouTubePlaylist},{identifiers:["list=FL","p=FL"],dataSourceType:e.YouTubeFavorites},{identifiers:["list=AL","p=AL"],dataSourceType:e.YouTubeAutoGenerated},{identifiers:["/user/","/channel/","list=UU","p=UU"],dataSourceType:e.YouTubeChannel},{identifiers:["streamus:"],dataSourceType:e.SharedPlaylist}],r=function(e,t){var n=e.split(t),i="";if(n.length>1){i=e.split(t)[1];var o=i.indexOf("&");-1!==o&&(i=i.substring(0,o)),"list=AL"===t||"p=AL"===t?i="AL"+i:("list=RD"===t||"p=RD"===t)&&(i="RD"+i)}return i};_.each(s,function(e){var o=_.find(e.identifiers,function(e){var n=r(t,e);return""!==n});void 0!==o&&(i=r(t,o),n=e.dataSourceType)})}return{dataSourceType:n,dataSourceId:i}},parseYouTubeVideoIdFromUrl:function(e){var t=null,n=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|watch\?.*?\&v=)([^#\&\?]*).*/);return n&&11===n[2].length&&(t=n[2]),t},getTitle:function(n){if(n=$.extend({},{success:function(){},error:function(){},notifyOnError:!0},n),""!==this.get("title"))return n.success(this.get("title")),void 0;var i=this;switch(this.get("type")){case e.YouTubePlaylist:t.getPlaylistTitle({playlistId:this.get("sourceId"),success:function(e){i.set("title",e),n.success(e)},error:n.error});break;case e.YouTubeFavorites:case e.YouTubeChannel:t.getChannelName({channelId:this.get("sourceId"),success:function(e){i.set("title",e),n.success(e)},error:n.error});break;case e.YouTubeAutoGenerated:break;default:n.notifyOnError&&console.error("Unhandled dataSource type:",this.get("type")),n.error()}}});return n}),define("background/model/folder",["background/collection/playlists","background/model/playlist","background/model/video","background/model/settings","common/model/youTubeV2API","common/model/dataSource"],function(e,t,n,i,o,s){"use strict";function r(e,t,n){chrome.tabs.query({url:"*://*.youtube.com/watch?v*"},function(i){_.each(i,function(i){chrome.tabs.sendMessage(i.id,{event:e,type:t,data:n})})})}var a=Backbone.Model.extend({defaults:function(){return{id:null,title:"",playlists:new e,active:!1}},urlRoot:i.get("serverURL")+"Video/",parse:function(e){for(var t in e)e.hasOwnProperty(t)&&"00000000-0000-0000-0000-000000000000"===e[t]&&(e[t]=null);return e},initialize:function(){var t=this.get("playlists");if(t instanceof Backbone.Collection||(t=new e(t),this.set("playlists",t,{silent:!0})),!this.isNew()&&t.length>0){var n=localStorage.getItem(this.get("id")+"_activePlaylistId"),i=this.getPlaylistById(n)||t.at(0);i.set("active",!0)}this.on("destroy",function(){localStorage.removeItem(self.get("id")+"_activePlaylistId")}),this.listenTo(t,"sync",function(){this.trigger("sync")}),this.listenTo(t,"change:active",function(e,t){t&&localStorage.setItem(this.get("id")+"_activePlaylistId",e.get("id"))}),this.listenTo(t,"remove",function(e){e.get("active")&&localStorage.setItem(this.get("id")+"_activePlaylistId",null)}),this.listenTo(this.get("playlists"),"add",function(e){r("add","playlist",{id:e.get("id"),title:e.get("title")})}),this.listenTo(this.get("playlists"),"remove",function(e){r("remove","playlist",{id:e.get("id"),title:e.get("title")})}),this.listenTo(this.get("playlists"),"change:title",function(e){r("rename","playlist",{id:e.get("id"),title:e.get("title")})})},addVideoByIdToPlaylist:function(e,t){this.get("playlists").get(t).addVideoByIdToPlaylist(e)},addPlaylistByInformation:function(e,t){if(_.isArray(t)){var i=_.map(t,function(e){return new n({videoInformation:e})});this.addPlaylistWithVideos(e,i)}else{var o=new n({videoInformation:t});this.addPlaylistWithVideos(e,o)}},addPlaylistWithVideos:function(e,n){var i=this,o=[];_.isArray(n)?o=_.map(n,function(e){return{video:e}}):o.push({video:n});var s=new t({title:e,folderId:this.get("id"),items:o});s.save({},{success:function(){s.get("items").playlistId=s.get("id"),i.get("playlists").push(s)}})},addPlaylistByShareData:function(e,n,o){var s=this;$.ajax({url:i.get("serverURL")+"Playlist/CreateCopyByShareCode",dataType:"json",data:{shareCodeShortId:e,urlFriendlyEntityTitle:n,folderId:s.get("id")},success:function(e){e=new t(e),s.get("playlists").push(e),o(e),s.trigger("sync")},error:function(e){console.error("Error adding playlist by share data",e),o()}})},addEmptyPlaylist:function(e){this.addPlaylistByDataSource(e,new s)},addPlaylistByDataSource:function(e,i){var s=this,r=new t({title:e,folderId:this.get("id"),dataSource:i,dataSourceLoaded:!i.needsLoading()});r.save({},{success:function(){r.get("items").playlistId=r.get("id"),s.get("playlists").push(r),i.needsLoading()&&(i.isV3()||o.getDataSourceResults(i,0,function e(t){if(0===t.results.length)r.set("dataSourceLoaded",!0);else{var s=_.map(t.results,function(e){return new n({videoInformation:e})});r.addByVideos(s,function(){o.getDataSourceResults(i,++t.iteration,e)})}}))},error:function(e){console.error(e)}})},removePlaylistById:function(e){var t=this.get("playlists").get(e);t.destroy({success:function(){playlists.remove(t)},error:function(e){console.error(e)}})},getActivePlaylist:function(){return this.get("playlists").findWhere({active:!0})},getPlaylistById:function(e){return this.get("playlists").findWhere({id:e})},getSequenceFromIndex:function(e){var t,n=1e4,i=this.get("playlists");if(0===i.length)t=n;else{var o=i.at(i.length-1).get("sequence")+n;e<i.length&&(o=i.at(e).get("sequence"));var s=0;e>0&&(s=i.at(e-1).get("sequence")),t=(o+s)/2}return t}});return a}),define("background/collection/folders",["background/model/folder","background/model/video","common/model/youTubeV2API"],function(e,t,n){"use strict";var i=Backbone.Collection.extend({model:e,initialize:function(){chrome.runtime.onMessage.addListener(function(e,i,o){switch(e.method){case"getFolders":o({folders:this});break;case"getPlaylists":var s=this.get(e.folderId),r=s.get("playlists");o({playlists:r});break;case"addVideoByIdToPlaylist":n.getVideoInformation({videoId:e.videoId,success:function(n){var i=new t({videoInformation:n}),s=this.getActiveFolder().get("playlists").get(e.playlistId);s.addByVideo(i),o({result:"success"})}.bind(this),error:function(){o({result:"error"})}});break;case"addPlaylistByShareData":var a=this.getActiveFolder();a.addPlaylistByShareData(e.shareCodeShortId,e.urlFriendlyEntityTitle,function(e){e?o({result:"success",playlistTitle:e.get("title")}):o({result:"error"})})}}.bind(this))},getActiveFolder:function(){return this.findWhere({active:!0})}});return window.Folders=new i,window.Folders}),define("common/model/relatedVideoInformationManager",["common/model/youTubeV2API"],function(e){"use strict";var t=Backbone.Model.extend({defaults:function(){return{concurrentRequestCount:0,maxConcurrentRequests:5,requestQueue:[]}},getRelatedVideoInformation:function(t){return this.canRequest()?(this.set("concurrentRequestCount",this.get("concurrentRequestCount")+1),e.sendV2ApiRequest({url:"https://gdata.youtube.com/feeds/api/videos/"+t.videoId+"/related",data:{category:"Music",fields:e.get("videoListInformationField"),"max-results":10},success:function(n){var i=[],o=[];_.each(n.feed.entry,function(t){var n=e.validateEntry(t);n?i.push(t):o.push(t)});var s=_.map(o,function(t){return e.findPlayableByTitle({title:t.title.$t,success:function(e){i.push(e)},error:function(e){console.error("There was an error find a playable entry for:"+t.title.$t,e)}})});$.when.apply($,s).done(function(){this.set("concurrentRequestCount",this.get("concurrentRequestCount")-1),t.success(i);var e=this.get("requestQueue");if(e.length>0){var n=e.shift();this.getRelatedVideoInformation(n)}}.bind(this))}.bind(this),error:t.error}),void 0):(this.get("requestQueue").push(t),void 0)},canRequest:function(){return this.get("concurrentRequestCount")<this.get("maxConcurrentRequests")}});return new t}),define("background/model/streamItem",["background/model/video","common/model/relatedVideoInformationManager"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:function(){return{id:_.uniqueId("streamItem_"),video:null,title:"",playedRecently:!1,selected:!1,relatedVideoInformation:[]}},sync:function(){return!1},initialize:function(){var n=this.get("video");n instanceof Backbone.Model||this.set("video",new e(n),{silent:!0}),this.on("change:selected",function(e,t){t&&this.set("playedRecently",!0)}),t.getRelatedVideoInformation({videoId:this.get("video").get("id"),success:function(e){if(null==e)throw"Related video information not found."+videoId;this.set("relatedVideoInformation",e)}.bind(this)})}});return n}),define("background/model/youTubePlayerAPI",[],function(){"use strict";var e=Backbone.Model.extend({defaults:{ready:!1},initialize:function(){chrome.webRequest.onBeforeSendHeaders.addListener(function(e){var t=_.find(e.requestHeaders,function(e){return"Referer"===e.name}),n=e.url.substring(0,e.url.indexOf("/embed/"));void 0===t?e.requestHeaders.push({name:"Referer",value:n}):t.value=n;var i=_.find(e.requestHeaders,function(e){return"User-Agent"===e.name}),o="Mozilla/5.0 (iPhone; U; CPU iPhone OS 4_3_2 like Mac OS X; en-us) AppleWebKit/533.17.9 (KHTML, like Gecko) Version/5.0.2 Mobile/8H7 Safari/6533.18.5";return void 0===i?e.requestHeaders.push({name:"User-Agent",value:o}):i.value=o,{requestHeaders:e.requestHeaders}},{urls:["*://*.youtube.com/embed/?enablejsapi=1&origin=chrome-extension:\\\\jbnkffmindojffecdhbbmekbmkkfpmjd"]},["blocking","requestHeaders"]),window.onYouTubePlayerAPIReady=function(){this.set("ready",!0)}.bind(this),$("<script>",{src:"https://www.youtube.com/iframe_api",async:!0}).insertBefore($("script:first"))}});return new e}),define("enum/playerState",{Unstarted:-1,Ended:0,Playing:1,Paused:2,Buffering:3,VideoCued:5}),define("background/model/player",["background/model/youTubePlayerAPI","background/model/settings","enum/playerState"],function(e,t,n){"use strict";var i=null,o=Backbone.Model.extend({defaults:{currentTime:0,ready:!1,state:n.Unstarted,volume:50,muted:!1,loadedVideoId:""},initialize:function(){function t(){new window.YT.Player("dummyTarget");var e=-1!==$("#dummyTarget").attr("src").indexOf("https");$("#dummyTarget").remove(),i=new window.YT.Player("MusicHolder",{events:{onReady:function(){o.set("muted",i.isMuted()),o.set("volume",i.getVolume()),o.pause(),o.set("ready",!0)},onStateChange:function(e){o.set("state",e.data)},onError:function(e){console.error("An error was encountered.",e),o.trigger("error",e.data)}}});var t=e?"https":"http";t+="://www.youtube.com/embed/?enablejsapi=1&origin=chrome-extension:\\\\jbnkffmindojffecdhbbmekbmkkfpmjd",$("#MusicHolder").attr("src",t)}var o=this;this.on("change:volume",function(e,t){o.set("muted",!1),i.setVolume(t)}),this.on("change:muted",function(e,t){t?i.mute():i.unMute()});var s=null;this.on("change:state",function(e,t){if(clearInterval(s),t===n.Paused){var i=288e5;s=setInterval(function(){o.cueVideoById(o.get("loadedVideoId"),o.get("currentTime"))},i)}}),chrome.runtime.onConnect.addListener(function(e){"youTubeIFrameConnectRequest"===e.name&&e.onMessage.addListener(function(e){void 0!==e.canvasDataURL&&o.set("canvasDataUrl",e.canvasDataURL).trigger("change:canvasDataUrl"),void 0!==e.currentTime&&o.set("currentTime",e.currentTime),void 0!==e.seeking&&(e.seeking?o.get("state")===n.Playing&&o.set("state",n.Buffering):o.get("state")===n.Buffering&&o.set("state",n.Playing))})}),e.get("ready")?t():e.once("change:ready",t)},cueVideoById:function(e,n){this.get("loadedVideoId")===e&&this.trigger("change:loadedVideoId"),this.set("loadedVideoId",e),null===i?console.error("youTubePlayer not instantiated"):i.cueVideoById({videoId:e,startSeconds:n||0,suggestedQuality:t.get("suggestedQuality")}),this.set("currentTime",n||0)},loadVideoById:function(e,o){this.get("loadedVideoId")===e&&this.trigger("change:loadedVideoId"),this.set("state",n.Buffering),this.set("loadedVideoId",e),i.loadVideoById({videoId:e,startSeconds:o||0,suggestedQuality:t.get("suggestedQuality")})},isPlaying:function(){return this.get("state")===n.Playing},mute:function(){this.set("muted",!0),i.mute()},unMute:function(){this.set("muted",!1),i.unMute()},stop:function(){this.set("state",n.Unstarted),i.stopVideo(),this.set("loadedVideoId","")},pause:function(){i.pauseVideo()},play:function(){this.isPlaying()||(this.set("state",n.Buffering),i.playVideo())},playOnceVideoChanges:function(){var e=this;this.once("change:loadedVideoId",function(){setTimeout(function(){e.play()})})},seekTo:_.debounce(function(e){var t=this.get("state");t===n.Unstarted||t===n.VideoCued?this.cueVideoById(this.get("loadedVideoId"),e):i.seekTo(e,!0)},100),setSuggestedQuality:function(e){i.setPlaybackQuality(e)}});return window.YouTubePlayer=new o,window.YouTubePlayer}),define("background/model/buttons/shuffleButton",[],function(){"use strict";var e=Backbone.Model.extend({defaults:{enabled:!1},toggleEnabled:function(){this.set("enabled",!this.get("enabled"))}});return window.ShuffleButton=new e,window.ShuffleButton}),define("background/model/buttons/radioButton",[],function(){"use strict";var e=Backbone.Model.extend({defaults:{enabled:!1},toggleRadio:function(){this.set("enabled",!this.get("enabled"))}});return window.RadioButton=new e,window.RadioButton}),define("background/model/buttons/repeatButton",["enum/repeatButtonState"],function(e){"use strict";var t=Backbone.Model.extend({defaults:{state:e.Disabled},toggleRepeat:function(){var t=null;switch(this.get("state")){case e.Disabled:t=e.RepeatVideo;break;case e.RepeatVideo:t=e.RepeatStream;break;case e.RepeatStream:t=e.Disabled;break;default:console.error("Unhandled repeatButtonState:",this.state)}this.set("state",t)}});return window.RepeatButton=new t,window.RepeatButton}),define("background/collection/streamItems",["background/notifications","background/model/streamItem","background/model/video","background/model/player","background/model/buttons/shuffleButton","background/model/buttons/radioButton","background/model/buttons/repeatButton","enum/repeatButtonState","enum/playerState","common/model/utility","common/model/youTubeV2API"],function(e,t,n,i,o,s,r,a,d,l,u){"use strict";var c=Backbone.Collection.extend({model:t,initialize:function(){_.extend(this,{history:[]}),_.extend(this,{bannedVideoIdList:[]});var t=this;this.on("add",function(e){e.get("selected")&&e.trigger("change:selected",e,!0),0===this.selected().length&&e.set("selected",!0)}),this.on("change:selected",function(e,t){if(t){this.deselectAllExcept(e.cid);var n=e.get("video").get("id"),o=i.get("state");o===d.Playing||o===d.Ended?i.loadVideoById(n):i.cueVideoById(n)}}),this.listenTo(i,"change:state",function(t,n){if(n===d.Ended)this.selectNext();else if(n===d.Playing){var i=chrome.extension.getViews({type:"popup"});
if(0===i.length){var o=this.getSelectedItem(),s=o.get("video").get("id");e.showNotification({iconUrl:"http://img.youtube.com/vi/"+s+"/default.jpg",title:"Now Playing",message:o.get("title")})}}}),this.on("remove reset",function(){0===this.length&&i.stop()}),this.on("remove",function(e,t,n){e.get("selected")&&this.length>0&&this.selectNext(n.index)}),this.on("change:playedRecently",function(){this.where({playedRecently:!0}).length===this.length&&this.each(function(e){e.set("playedRecently",!1)})}),chrome.runtime.onMessage.addListener(function(e){switch(e.method){case"searchAndStreamByQuery":t.searchAndAddByName(e.query,!0);break;case"searchAndStreamByQueries":var n=e.queries;if(n.length>0){var i=n.shift(),o=function(){n.length>0&&(i=n.shift(),t.searchAndAddByName(i,!1,o))};t.searchAndAddByName(i,!0,function(){o()})}}})},searchAndAddByName:function(e,t,i){var o=this;u.search({text:e,maxResults:10,success:function(s){if(0===s.length)console.error("Failed to find any videos for:",e);else{var r=new n({videoInformation:s[0]});o.addByVideo(r,!!t)}i&&i()}})},addByPlaylistItems:function(e,t){var n=e.pluck("video");1===n.length?this.addByVideo(n[0],t):this.addByVideos(n,t)},addByDraggedVideoSearchResults:function(e,t){if(!_.isArray(e))throw"Error";var n=_.map(e,function(e){return{video:e.get("video"),title:e.get("video").get("title")}});this.add(n,{at:t})},addByDraggedPlaylistItems:function(e,t){if(!_.isArray(e))throw"Error";var n=_.map(e,function(e){return{video:e.get("video"),title:e.get("title")}});this.add(n,{at:t})},addByPlaylistItem:function(e,t){t&&i.playOnceVideoChanges(),this.add({video:e.get("video"),title:e.get("title"),selected:t})},addByVideo:function(e,t){t&&i.playOnceVideoChanges(),this.add({video:e,title:e.get("title"),selected:t})},addByVideos:function(e,n){if(!_.isArray(e))return this.addByVideo(e,n);n&&i.playOnceVideoChanges();var o=_.map(e,function(e,i){return new t({video:e,title:e.get("title"),selected:n&&0===i})});this.add(o)},deselectAllExcept:function(e){this.each(function(t){t.cid!=e&&t.set("selected",!1)})},getSelectedItem:function(){return this.findWhere({selected:!0})||null},getRelatedVideos:function(){var e=this.filter(function(e){return null!=e.get("relatedVideoInformation")}),t=_.flatten(_.map(e,function(e){return _.map(e.get("relatedVideoInformation"),function(e){return new n({videoInformation:e})})})),i=this;t=_.filter(t,function(e){var t=i.find(function(t){var n=t.get("video").get("id")===e.get("id"),o=t.get("video").get("cleanTitle")===e.get("cleanTitle"),s=_.contains(i.bannedVideoIdList,e.get("id"));return n||o||s});return null==t});var o=_.filter(t,function(e){var t=e.get("duration")<480,n=-1===e.get("title").toLowerCase().indexOf("live");return t&&n});return 0!==o.length&&(t=o),t},getRandomRelatedVideo:function(){var e=this.getRelatedVideos(),t=e[_.random(e.length-1)]||null;return t},selectNext:function(e){var t=null,n=o.get("enabled"),d=s.get("enabled"),l=r.get("state");if(void 0===e&&l===a.RepeatVideo){var u=this.findWhere({selected:!0});u.trigger("change:selected",u,!0),t=u}else if(n){var c=_.shuffle(this.where({playedRecently:!1}));c[0].set("selected",!0),t=c[0]}else{var g;if(void 0!==e&&null!==e)g=e;else if(g=this.indexOf(this.findWhere({selected:!0}))+1,0>=g)throw"Failed to find nextItemIndex";if(g===this.length)if(l===a.RepeatStream)this.at(0).set("selected",!0),1===this.length&&this.at(0).trigger("change:selected",this.at(0),!0),t=this.at(0);else if(void 0!==e&&null!==e)this.at(this.length-1).set("selected",!0),i.pause();else if(d){var h=this.getRandomRelatedVideo();null===h?console.error("No related video found."):t=this.add({video:h,title:h.get("title"),selected:!0})}else this.at(0).set("selected",!0),i.pause();else this.at(g).set("selected",!0),t=this.at(g)}return t},selectPrevious:function(){this.history.shift();var e=this.history.shift();if(null==e){var t=o.get("enabled"),n=r.get("state");if(n===a.RepeatVideo){var i=this.findWhere({selected:!0});i.trigger("change:selected",i,!0)}else if(t){var s=_.shuffle(this.where({playedRecently:!1}));s[0].set("selected",!0)}else{var d=this.indexOf(this.findWhere({selected:!0}));0===d?n===a.RepeatStream&&this.at(this.length-1).set("selected",!0):this.at(d-1).set("selected",!0)}}else e.set("selected",!0)},ban:function(e){this.bannedVideoIdList.push(e.get("video").get("id"))},clear:function(){this.bannedVideoIdList=[],this.reset()},selected:function(){return this.where({selected:!0})}});return window.StreamItems=new c,window.StreamItems}),define("background/model/buttons/nextButton",["background/collection/streamItems","background/model/buttons/radioButton","background/model/buttons/shuffleButton","background/model/buttons/repeatButton","enum/repeatButtonState"],function(e,t,n,i,o){"use strict";var s=Backbone.Model.extend({defaults:{enabled:!1},initialize:function(){this.listenTo(e,"add remove reset change:selected",this.toggleEnabled),this.listenTo(t,"change:enabled",this.toggleEnabled),this.listenTo(n,"change:enabled",this.toggleEnabled),this.listenTo(i,"change:state",this.toggleEnabled),this.toggleEnabled()},toggleEnabled:function(){var s=!1;if(e.length>0){var r=t.get("enabled"),a=n.get("enabled"),d=i.get("state");if(a&&e.length>1)s=!0;else if(r||d!==o.Disabled)s=!0;else{var l=e.indexOf(e.findWhere({selected:!0}));l+1!==e.length&&(s=!0)}}this.set("enabled",s)},trySelectNextVideo:_.debounce(function(){var t=!1;if(this.get("enabled")){var n=e.selectNext();t=null!==n}return t},100,!0)});return window.NextButton=new s,window.NextButton}),define("background/model/buttons/previousButton",["background/collection/streamItems","background/model/player"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:{enabled:!1},initialize:function(){this.listenTo(e,"add remove change:selected sort",this.toggleEnabled),this.listenTo(t,"change:currentTime",this.toggleEnabled),this.toggleEnabled()},toggleEnabled:function(){var n=!1;if(e.length>0){var i=e.getSelectedItem();e.indexOf(i)>0?n=!0:t.get("currentTime")>0&&(n=!0)}this.set("enabled",n)},tryDoTimeBasedPrevious:_.debounce(function(){return this.get("enabled")&&(1===e.length||t.get("currentTime")>5?t.seekTo(0):e.selectPrevious()),this.get("enabled")},100,!0)});return window.PreviousButton=new n,window.PreviousButton}),define("background/model/buttons/playPauseButton",["background/collection/streamItems","background/model/player"],function(e,t){"use strict";var n=Backbone.Model.extend({defaults:{enabled:!1},initialize:function(){this.listenTo(e,"change:selected remove reset",this.toggleEnabled),this.toggleEnabled()},toggleEnabled:function(){this.set("enabled",e.where({selected:!0}).length>0)},tryTogglePlayerState:_.debounce(function(){return this.get("enabled")&&(t.isPlaying()?t.pause():t.play()),this.get("enabled")},100,!0)});return window.PlayPauseButton=new n,window.PlayPauseButton}),define("background/model/buttons/videoDisplayButton",["background/collection/streamItems"],function(e){"use strict";var t=Backbone.Model.extend({defaults:{enabled:!1,disabled:!0},initialize:function(){this.listenTo(e,"add remove reset",this.setDisabled)},setDisabled:function(){this.set("disabled",0===e.length)},toggleEnabled:function(){this.set("enabled",!this.get("enabled"))},toggleVideoDisplay:function(){console.error("not implemented")}});return window.VideoDisplayButton=new t,window.VideoDisplayButton}),define("background/commands",["background/notifications","background/collection/folders","background/collection/streamItems","background/model/player","background/model/buttons/nextButton","background/model/buttons/previousButton","background/model/buttons/playPauseButton","background/model/buttons/radioButton","background/model/buttons/repeatButton","background/model/buttons/shuffleButton","background/model/buttons/videoDisplayButton"],function(e,t,n,i,o,s,r,a,d,l,u){"use strict";chrome.commands.onCommand.addListener(function(i){switch(i){case"nextVideo":var c=o.trySelectNextVideo();c||e.showNotification({title:chrome.i18n.getMessage("keyboardCommandFailure"),message:chrome.i18n.getMessage("cantSkipToNextVideo")});break;case"previousVideo":var g=s.tryDoTimeBasedPrevious();g||e.showNotification({title:chrome.i18n.getMessage("keyboardCommandFailure"),message:chrome.i18n.getMessage("cantGoBackToPreviousVideo")});break;case"toggleVideo":var h=r.tryTogglePlayerState();h||e.showNotification({title:chrome.i18n.getMessage("keyboardCommandFailure"),message:chrome.i18n.getMessage("cantToggleVideoState")});break;case"toggleRadio":a.toggleRadio();break;case"toggleShuffle":l.toggleShuffle();break;case"toggleRepeat":d.toggleRepeat();break;case"toggleVideoDisplay":u.toggleVideoDisplay();break;case"addVideoToPlaylist":var f=t.getActiveFolder().getActivePlaylist();f.addByVideo(n.getSelectedItem().get("video"));break;case"deleteVideoFromStream":n.getSelectedItem().destroy();break;case"copyVideoUrl":chrome.extension.sendMessage({method:"copy",text:n.getSelectedItem().get("video").get("url")});break;case"copyVideoTitleAndUrl":var m=n.getSelectedItem();chrome.extension.sendMessage({method:"copy",text:'"'+m.get("title")+'" - '+m.get("video").get("url")});break;default:console.error("Unhandled command:",i)}})}),define("background/model/videoSearchResult",[],function(){"use strict";var e=Backbone.Model.extend({defaults:function(){return{id:_.uniqueId("videoSearchResult_"),selected:!1,firstSelected:!1,video:null}},sync:function(){return!1}});return e}),define("background/collection/videoSearchResults",["background/collection/multiSelectCollection","background/model/videoSearchResult","background/model/video"],function(e,t,n){"use strict";var i=e.extend({model:t,clear:function(){this.setResults()},setResults:function(e){_.invoke(this.toArray(),"destroy"),this.reset(e)},setFromVideoInformation:function(e){var i=new t({video:new n({videoInformation:e})});this.setResults(i)},setFromVideoInformationList:function(e){var i=_.map(e,function(e){var i=new t({video:new n({videoInformation:e})});return i});this.setResults(i)},getByVideoId:function(e){var t=this.find(function(t){return t.get("video").get("id")===e});return t}});return window.VideoSearchResults=new i,window.VideoSearchResults}),define("background/model/user",["background/collection/folders","background/model/settings"],function(e,t){"use strict";var n="UserId",i=Backbone.Model.extend({defaults:function(){return{id:null,googlePlusId:"",name:"",dirty:!1,loaded:!1,folders:null}},urlRoot:t.get("serverURL")+"User/",initialize:function(){this.tryLoginFromStorage()},tryLoginFromStorage:function(){var e=this;chrome.storage.sync.get(n,function(i){var o=i[n];"undefined"==typeof o?(o=t.get("userId"),null!==o?(e.set("id",o),e.loadFromServer(!0)):e.save({},{success:function(t){e.onLoaded(t,!0)},error:function(e){console.error(e)}})):(e.set("id",o),e.loadFromServer(!1))})},getUserInfo:function(e){this.getAuthToken(!1,!0,e)},getAuthToken:function(e,t,n){return"undefined"==typeof chrome.identity?(console.error("chrome.identity permission not granted."),n(null),void 0):(console.log("I am now calling chrome.identity.getAuthToken with interactive set to: "+e+" and retry set to "+t),chrome.identity.getAuthToken({interactive:e},function(e){if(chrome.runtime.lastError){var i=chrome.runtime.lastError.message;console.error(i),n(null)}else this.getUserInfoWithAuthToken(e,t,n)}.bind(this)),void 0)},getUserInfoWithAuthToken:function(e,t,n){var i=this;$.ajax({url:"https://www.googleapis.com/plus/v1/people/me",headers:{Authorization:"Bearer "+e},success:function(e){console.log("Received user info"),n(e)},error:function(o){401==o.status&&t?chrome.identity.removeCachedAuthToken({token:e},function(){i.getAuthToken(!1,!1,n)}):(n(null),console.error(o))}})},onLoaded:function(i,o){if(e.reset(this.get("folders")),e.at(0).set("active",!0),o){var s={};s[n]=i.get("id"),chrome.storage.sync.set(s)}this.set("loaded",!0),t.set("userId",this.get("id")),this.getUserInfo(function(e){null!==e&&this.updateWithGooglePlusId(e.id)}.bind(this)),console.log("User has loaded with UserID:",this.get("id"))},loadFromServer:function(e){var n=this;this.set("loaded",!1),this.fetch({success:function(t){n.onLoaded(t,e)},error:function(e){console.error(e),t.get("localDebug")&&(n.set("id",null),n.save({},{success:function(e){n.onLoaded(e,!0)}}))}})},updateWithGooglePlusId:function(e){$.ajax({url:t.get("serverURL")+"User/UpdateGooglePlusId",type:"POST",dataType:"json",data:{userId:this.get("id"),googlePlusId:e}})},tryLoginWithGooglePlusId:function(){}});return window.User=new i,window.User}),define("background/model/contextMenus",["background/collection/streamItems","background/collection/folders","background/model/user","background/model/video","enum/dataSourceType","common/model/youTubeV2API","common/model/utility","common/model/dataSource"],function(e,t,n,i,o,s,r,a){"use strict";var d=Backbone.Model.extend({documentUrlPatterns:["*://*.youtube.com/watch?*","*://*.youtu.be/*"],targetUrlPatterns:["*://*.youtube.com/watch?*","*://*.youtu.be/*"],initialize:function(){n.get("loaded")?(this.createContextMenus(["link"],this.targetUrlPatterns,!0),this.createContextMenus(["page"],this.documentUrlPatterns,!1)):this.listenToOnce(n,"change:loaded",function(){this.createContextMenus(["link"],this.targetUrlPatterns,!0),this.createContextMenus(["page"],this.documentUrlPatterns,!1)})},createContextMenus:function(n,i,o){var s=this,r={contexts:n,targetUrlPatterns:o?i:void 0,documentUrlPatterns:o?void 0:i},a=chrome.contextMenus.create(_.extend({},r,{title:"Streamus"}));chrome.contextMenus.create(_.extend({},r,{title:chrome.i18n.getMessage("play"),parentId:a,onclick:function(t){var n=t.linkUrl||t.pageUrl;s.getVideoFromUrl(n,function(t){e.addByVideo(t,!0)})}})),chrome.contextMenus.create(_.extend({},r,{title:chrome.i18n.getMessage("enqueue"),parentId:a,onclick:function(t){var n=t.linkUrl||t.pageUrl;s.getVideoFromUrl(n,function(t){e.add({video:t,title:t.get("title")})})}}));var d=chrome.contextMenus.create(_.extend({},r,{title:chrome.i18n.getMessage("save"),parentId:a})),l=t.getActiveFolder().get("playlists");l.each(function(e){s.createPlaylistContextMenu(r,d,e)}),this.listenTo(l,"add",function(e){this.createPlaylistContextMenu(r,d,e)})},createPlaylistContextMenu:function(e,t,n){var i=this,o=chrome.contextMenus.create(_.extend({},e,{title:n.get("title"),parentId:t,onclick:function(e){var t=e.linkUrl||e.pageUrl;i.getVideoFromUrl(t,function(e){n.addByVideo(e)})}}));this.listenTo(n,"change:title",function(){chrome.contextMenus.update(o,{title:n.get("title")})}),this.listenTo(n,"destroy",function(){chrome.contextMenus.remove(o)})},getVideoFromUrl:function(e,t){var n=new a({urlToParse:e});if(n.get("type")!==o.YouTubeVideo)throw"Excepected dataSource to be a YouTube video.";s.getVideoInformation({videoId:n.get("sourceId"),success:function(e){var n=new i({videoInformation:e});t(n)},error:function(e){console.error(e)}})}});return new d}),define("background/model/error",["background/model/settings"],function(e){"use strict";var t=Backbone.Model.extend({defaults:function(){var e="undefined"==typeof chrome?"":chrome.app.getDetails(),t=e?e.version:"Unknown";return{message:"",lineNumber:-1,url:"",clientVersion:t,timeOccurred:null,operatingSystem:"",architecture:""}},urlRoot:e.get("serverURL")+"Error/",initialize:function(e){var t=e.message;t&&t.length>255&&this.set("message",t.substring(0,252)+"...")},validate:function(e){return e.message.length>255?"Message length must be no longer than 255 characters":void 0}}),n={os:"",arch:"",nacl_arch:""};return chrome.runtime.getPlatformInfo(function(e){n=e,console.log("PlatformInfo:",n)}),window.onerror=_.throttle(function(i,o,s){if(!e.get("localDebug")){o=o.replace("chrome-extension://jbnkffmindojffecdhbbmekbmkkfpmjd/","");var r=new t({message:i,url:o,lineNumber:s,operatingSystem:n.os,architecture:n.arch});r.save()}},6e4),t}),define("background/model/iconManager",["background/model/player","enum/playerState"],function(e,t){"use strict";function n(e,n,i){var o;o=n?"Red":e===t.Playing||e===t.Buffering?"Green":"Yellow";var s=Math.ceil(i/25);chrome.browserAction.setIcon({path:"../../img/"+o+" "+s+".png"})}var i=Backbone.Model.extend({initialize:function(){var t=function(){var t=e.get("state"),i=e.get("muted"),o=e.get("volume");n(t,i,o)};e.get("ready")?t():e.once("change:ready",t),this.listenTo(e,"change:muted",function(t,i){var o=e.get("state"),s=e.get("volume");n(o,i,s)}),this.listenTo(e,"change:state",function(t,i){var o=e.get("muted"),s=e.get("volume");n(i,o,s)}),this.listenTo(e,"change:volume",function(t,i){var o=e.get("state"),s=e.get("muted");n(o,s,i)})}});return new i}),define("background/model/omnibox",["background/collection/streamItems","background/model/video","common/model/youTubeV2API","common/model/utility"],function(e,t,n,i){"use strict";var o=Backbone.Model.extend({defaults:{suggestedVideos:[],searchJqXhr:null},initialize:function(){var t=this;chrome.omnibox.setDefaultSuggestion({description:"Press enter to play."}),chrome.omnibox.onInputChanged.addListener(function(e,i){t.get("suggestedVideos").length=0;var o=$.trim(e);if(""===o)i();else{var s=t.get("searchJqXhr");s&&(s.abort(),t.set("searchJqXhr",null));var r=n.search({text:o,maxResults:6,success:function(e){t.set("searchJqXhr",null);var n=t.buildSuggestions(e,o);i(n)}});t.set("searchJqXhr",r)}}),chrome.omnibox.onInputEntered.addListener(function(n){var i=_.find(t.get("suggestedVideos"),function(e){return e.get("url")===n});void 0===i&&(i=t.get("suggestedVideos")[0]),e.addByVideo(i,!0)})},buildSuggestions:function(e,n){var o=this,s=_.map(e,function(e){var s=new t({videoInformation:e});o.get("suggestedVideos").push(s);var r=_.escape(s.get("title")),a=new RegExp(i.escapeRegExp(n),"i"),d=r.replace(a,"<match>$&</match>"),l="<dim>"+s.get("prettyDuration")+"</dim>  "+d;return{content:s.get("url"),description:l}});return s}});return new o}),define("background/view/clipboardView",[],function(){"use strict";var e=Backbone.View.extend({el:$("textarea#clipboard"),initialize:function(){chrome.runtime.onMessage.addListener(function(e){return"copy"===e.method&&(this.$el.val(e.text).select(),document.execCommand("copy",!1,null)),!0}.bind(this))}});return new e}),define("background/background",["background/commands","background/collection/folders","background/collection/videoSearchResults","background/model/player","background/model/contextMenus","background/model/error","background/model/iconManager","background/model/omnibox","background/model/user","background/view/clipboardView"],function(){"use strict";window.onmessage=function(e){if("https://www.youtube.com"===e.origin&&e.ports.length>0&&"connect"===e.data){var t=e.ports[0];t.onmessage=function(e){console.log("background message:",e)}}}});