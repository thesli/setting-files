function dataURItoBlob(b,h){var g=atob(b.split(",")[1]);var a=b.split(",")[0].split(":")[1].split(";")[0];var e=new ArrayBuffer(g.length);var c=new Uint8Array(e);for(var d=0;d<g.length;d++){c[d]=g.charCodeAt(d)}var f=new window.WebKitBlobBuilder();f.append(e);return f.getBlob(a)}function strstr(b,c,a){var d=0;b+="";d=b.indexOf(c);if(d==-1){return false}else{if(a){return b.substr(0,d)}else{return b.slice(d)}}}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;function fileErrorHandler(b){var c="";var a=0;switch(b.code){case FileError.QUOTA_EXCEEDED_ERR:c="Speed Dial 2's thumbnail file storage limit has been reached.";break;case FileError.NOT_FOUND_ERR:c="Speed Dial 2 is unable to access one or more thumbnail files.\n\nYou may need to reinstall Speed Dial 2 and/or Chrome.";break;case FileError.SECURITY_ERR:a=1;break;case FileError.INVALID_MODIFICATION_ERR:c="Speed Dial 2 is unable to modify its thumbnail files.";break;case FileError.INVALID_STATE_ERR:c="Speed Dial 2 is unable to access its thumbnail files (invalid state).";break;default:c="Speed Dial 2 has encountered an unknown thumbnail file error.";break}if(a==1){window.webkitNotifications.createHTMLNotification("/html/notification_fileSecurityErr.html").show();return}if(localStorage.option_alert==1){alert(c)}console.log(c)}$(document).on("change","#backgroundFile",function(c){var b=c.target.files[0];if(!strstr(b.type,"image/")){alert("Error: File is not an image.");return}var a=new FileReader();a.onload=(function(d){return function(f){window.requestFileSystem(window.PERSISTENT,50*1024*1024,function(e){e.root.getFile("/background.image",{create:true},function(g){g.createWriter(function(h){h.write(dataURItoBlob(f.target.result));setTimeout(function(){$("#backgroundFile").val("");setValue("options.background","filesystem:"+chrome.extension.getURL("persistent/background.image"));setValue("options.backgroundPattern","");show_message("Background set.")},1)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)}})(b);a.readAsDataURL(b)});