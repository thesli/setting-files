// Generated by CoffeeScript 1.6.1
(function() {
  var delay,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  BH.Router = (function(_super) {

    __extends(Router, _super);

    function Router() {
      return Router.__super__.constructor.apply(this, arguments);
    }

    Router.prototype.routes = {
      '': 'reset',
      'tags': 'tags',
      'tags/:id': 'tag',
      'weeks': 'weeks',
      'weeks/:id': 'week',
      'days/:id': 'day',
      'settings': 'settings',
      'search/*query(/p:page)': 'search',
      'search': 'search',
      'today': 'today'
    };

    Router.prototype.initialize = function(options) {
      var settings, tracker,
        _this = this;
      settings = options.settings;
      tracker = options.tracker;
      this.state = options.state;
      this.app = new BH.Views.AppView({
        el: $('.app'),
        collection: new BH.Collections.Weeks(),
        settings: settings,
        state: this.state
      });
      this.app.render();
      this.on('route', function(route) {
        tracker.pageView(Backbone.history.getFragment());
        window.scroll(0, 0);
        if (settings.get('openLocation') === 'last_visit') {
          return _this.state.set({
            route: location.hash
          });
        }
      });
      if (location.hash === '') {
        return this.reset;
      }
    };

    Router.prototype.reset = function() {
      return this.navigate(this.state.get('route'), {
        trigger: true
      });
    };

    Router.prototype.tags = function() {
      var view;
      view = this.app.loadTags();
      view.select();
      return delay(function() {
        return view.collection.fetch();
      });
    };

    Router.prototype.tag = function(id) {
      var view;
      view = this.app.loadTag(id);
      view.select();
      return delay(function() {
        return view.model.fetch();
      });
    };

    Router.prototype.weeks = function() {
      var view;
      view = this.app.loadWeeks();
      view.select();
      return delay(function() {
        return new BH.Lib.WeeksHistory().fetch(function(history) {
          return view.collection.reset(history);
        });
      });
    };

    Router.prototype.week = function(id) {
      var view;
      view = this.app.loadWeek(id);
      view.select();
      return delay(function() {
        return new BH.Lib.WeekHistory(new Date(id)).fetch(function(history) {
          return view.collection.reset(history);
        });
      });
    };

    Router.prototype.day = function(id) {
      var view;
      view = this.app.loadDay(id);
      view.select();
      return delay(function() {
        return new BH.Lib.DayHistory(new Date(id)).fetch(function(history) {
          return view.collection.reset(history);
        });
      });
    };

    Router.prototype.today = function() {
      var view;
      view = this.app.loadDay(moment(new Date()).id());
      view.select();
      return delay(function() {
        return new BH.Lib.DayHistory(new Date(id).fetch(function(history) {
          return view.model.parseAndSet(history);
        }));
      });
    };

    Router.prototype.settings = function() {
      var view;
      view = this.app.loadSettings();
      return view.select();
    };

    Router.prototype.search = function(query, page) {
      var view;
      if (query == null) {
        query = '';
      }
      view = this.app.loadSearch(query === '' || page ? {
        expired: true
      } : void 0);
      if (page != null) {
        view.page.set({
          page: parseInt(page, 10)
        }, {
          silent: true
        });
      }
      view.model.set({
        query: decodeURIComponent(query)
      });
      view.select();
      return delay(function() {
        if (query !== '') {
          return new BH.Lib.SearchHistory(query).fetch(function(history, cacheDatetime) {
            if (cacheDatetime == null) {
              cacheDatetime = null;
            }
            view.collection.reset(history);
            if (cacheDatetime != null) {
              return view.model.set({
                cacheDatetime: cacheDatetime
              });
            } else {
              return view.model.unset('cacheDatetime');
            }
          });
        }
      });
    };

    return Router;

  })(Backbone.Router);

  delay = function(callback) {
    return setTimeout((function() {
      return callback();
    }), 250);
  };

}).call(this);
